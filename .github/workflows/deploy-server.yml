name: Deploy GraphQL Azure Function

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'graphql-backend/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'DEV'
        type: choice
        options: [ DEV, PROD ]

# Needed so the cleanup step can delete artifacts created by this workflow
permissions:
  contents: read
  actions: write

env:
  NODE_VERSION: 20.17.0
  ENV_SUFFIX: 2
  ENV_NAME: ${{ github.event.inputs.environment && (github.event.inputs.environment == 'PROD' && 'prd' || 'dev') || (github.ref_name == 'main' && 'prd' || 'dev') }}

jobs:
  build:
    name: Build Function App
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: graphql-backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Build app
        run: npm run build:production

      - name: Prepare upload folder
        run: |
          echo "Prepare server artifact files"
          mkdir -p for_upload
          cp -r dist for_upload/dist
          cp host.json for_upload/
          cp package.json for_upload/
          cp -r node_modules for_upload/
          echo "Prepared contents:"
          ls -R for_upload

      - name: Zip artifacts
        run: |
          cd for_upload
          zip -r ../functionapp.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: functionapp
          path: graphql-backend/functionapp.zip

  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: build
    environment: ${{ github.event.inputs.environment || (github.ref_name == 'main' && 'PROD' || 'DEV') }}

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: functionapp
          path: .

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Function App
        uses: azure/functions-action@v1
        with:
          app-name: ${{ env.ENV_NAME == 'prd' && 'func-spiriverse-server-prd-002' || 'func-spiriverse-server-dev-002' }}
          package: functionapp.zip

      - name: Delete build artifact (post-deploy)
        if: ${{ success() }}
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const run_id = context.runId;
            const { data } = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const artifact = data.artifacts.find(a => a.name === 'functionapp');
            if (!artifact) {
              core.warning('Artifact "functionapp" not found on this run.');
            } else {
              await github.rest.actions.deleteArtifact({ owner, repo, artifact_id: artifact.id });
              core.info(`Deleted artifact ${artifact.name} (${artifact.id}).`);
            }
